<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneChain Wallet</title>
    <script src="https://bundle.run/buffer@6.0.3"></script>
    <script src="https://cdn.jsdelivr.net/npm/bip39@3.0.4/dist/index-browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.5.4/elliptic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link rel="stylesheet" href="wallet.css">
</head>
<body>

    <div class="app-container">
        <div class="header">
            <canvas id="addr-icon" width="32" height="32" style="border-radius: 50%;"></canvas>
            <div class="logo">âº <span>ONE</span> WALLET</div>
            <div class="header-actions">
                <button id="wallet-trigger" class="wallet-pill" onclick="openWalletSelector()">
                    <span id="active-wallet-name">Account 1</span>
                    <small id="active-wallet-addr"></small>
                </button>
                <button id="logout-btn" class="logout-btn" onclick="logout()">Logout</button>
            </div>
            <div id="modal-rpc" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Pengaturan RPC</h3>
            <button class="close-btn" onclick="closeModal('modal-rpc')">&times;</button>
        </div>
        <div style="padding: 10px 0;">
            <p class="text-muted" style="margin-bottom: 10px;">Masukkan URL RPC kustom Anda:</p>
            <input type="text" id="rpc-url-input" placeholder="https://your-rpc-url.com">
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button onclick="saveRPC()" class="btn" style="flex:1">Simpan</button>
                <button onclick="resetRPC()" class="btn btn-outline" style="flex:1; border-color: var(--danger); color: var(--danger);">Reset</button>
            </div>
        </div>
    </div>
</div>

<div class="action-btn" onclick="openRPCModal()">
    <div class="action-icon" style="background: #64748b;">âš™ï¸</div><span>RPC</span>
</div>

            <div id="modal-selector" class="modal-overlay">
                <div class="modal-content list-modal">
                    <div class="modal-header">
                        <h3>Pilih Wallet</h3>
                        <button class="close-btn" onclick="closeWalletSelector()">âœ•</button>
                    </div>
                    <div id="wallet-list-container" class="wallet-list"></div>
                    <button class="btn btn-outline" style="margin-top: 20px;" onclick="goToLogin()">
                        + Tambah Wallet Baru
                    </button>
                </div>
            </div>
        </div>

        <div id="login-view" class="screen active">
            <div class="text-center" style="margin-top: 20px; margin-bottom: 30px;">
                <h2>Selamat Datang</h2>
                <p class="text-muted">Masuk ke wallet OneChain kamu.</p>
            </div>
            
            <div class="tabs-container">
                <button class="btn-tab active" onclick="switchLoginTab('pk')">Private Key</button>
                <button class="btn-tab" onclick="switchLoginTab('phrase')">Phrase</button>
            </div>

            <div id="input-pk-container">
                <input type="password" id="privateKeyInput" placeholder="Masukkan Private Key">
            </div>
            
            <div id="input-phrase-container" style="display: none;">
                <textarea id="phraseInput" placeholder="12 kata pemulihan (pisahkan dengan spasi)" rows="3"></textarea>
            </div>

            <button class="btn" onclick="login()">Masuk Wallet</button>
            <button class="btn btn-outline" onclick="createOneWallet()">Buat Wallet Baru</button>

            <div id="new-wallet-info" style="display:none; margin-top:25px; background:#0f172a; padding:20px; border-radius:12px; border: 1px solid var(--border);">
                <p style="color:var(--primary); margin-top:0; font-weight: 600; margin-bottom: 15px;">âš ï¸ Simpan Cadangan Ini:</p>
                <div style="margin-bottom:15px;">
                    <strong class="text-muted" style="display: block; margin-bottom: 5px;">Mnemonic Phrase:</strong>
                    <span id="new-phrase" style="color:#10b981; font-family: monospace; font-size: 13px; line-height: 1.5; display: block;"></span>
                </div>
                <div>
                    <strong class="text-muted" style="display: block; margin-bottom: 5px;">Private Key:</strong>
                    <span id="new-priv" style="color:#10b981; font-family: monospace; font-size: 12px; word-break: break-all;"></span>
                </div>
            </div>
        </div>

        <div id="dashboard-view" class="screen">
            <div class="address-box" onclick="copyAddress('display-address')">
                <span id="display-address"></span> <span style="font-size: 14px;">ğŸ“‹</span>
            </div>
            
            <div class="balance-card">
                <h1 id="display-balance" class="balance-amount" onclick="this.classList.toggle('balance-hidden')">0.00</h1>
                <div class="balance-symbol">ONE</div>
                <div class="fiat-balance" id="display-fiat">â‰ˆ $0.00 USD</div>
            </div>

            <div class="actions">
                <div class="action-btn" onclick="showSend()">
                    <div class="action-icon">â†—</div><span>Kirim</span>
                </div>
                <div class="action-btn" onclick="showReceive()">
                    <div class="action-icon">â†™</div><span>Terima</span>
                </div>
                <div class="action-btn" onclick="refreshData()">
                    <div class="action-icon">â†»</div><span>Refresh</span>
                </div>
            </div>

            <button class="btn btn-outline" style="border-color: var(--border); color: var(--text); padding: 10px; margin-bottom: 20px;" onclick="openBackupModal()">
                ğŸ›¡ï¸ Lihat Cadangan Wallet
            </button>

            <div style="margin-top: auto;">
                <h4 style="font-size: 14px;">Riwayat Terakhir</h4>
                <div id="tx-history" style="font-size: 13px; color: var(--text-muted); height: 100px; overflow-y: auto; background: #0f172a; border-radius: 12px; padding: 15px;">
                    <div class="text-center" style="margin-top: 15px;">Belum ada transaksi</div>
                </div>
            </div>

            <button class="action-btn" onclick="openDAppModal()">
    ğŸŒ Kelola Koneksi DApp
</button>

            <div id="modal-dapps" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>DApp Terhubung</h3>
            <button class="close-btn" onclick="closeModal('modal-dapps')">&times;</button>
        </div>
        <div id="dapp-list" class="dapp-list-container">
            </div>
    </div>
</div>

            <div id="modal-dapp-approve" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>Permintaan Koneksi</h3>
        <p>Website ini ingin terhubung ke wallet Anda:</p>
        <div id="dapp-origin-display" style="font-weight: bold; margin: 10px 0; color: var(--primary);"></div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="approveDApp()" class="btn-primary" style="flex:1">Izinkan</button>
            <button onclick="rejectDApp()" class="btn-danger" style="flex:1">Tolak</button>
        </div>
    </div>
</div>
        </div>

        <div id="receive-view" class="screen">
            <div class="text-center">
                <h3>Terima ONE</h3>
                <p class="text-muted">Scan QR code di bawah ini untuk menerima aset.</p>
                <div class="qr-container">
                    <img id="qr-code-img" src="" alt="QR Code" width="180" height="180">
                </div>
                <div class="address-box" onclick="copyAddress('receive-address')" style="margin-top: 10px; width: 100%; justify-content: center; padding: 12px;">
                    <span id="receive-address" style="word-break: break-all;"></span> ğŸ“‹
                </div>
            </div>
            <button class="btn btn-outline" style="margin-top: auto;" onclick="showDashboard()">Kembali</button>
        </div>

        <div id="send-view" class="screen">
            <h3>Kirim Aset</h3>
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <input type="text" id="send-to" placeholder="Alamat tujuan (one...)" oninput="validateTargetAddress(this.value)">
                <small id="address-warning" style="color: var(--danger); font-size: 10px; display: none;">Format alamat tidak valid!</small>
                <button onclick="startScan()" style="background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 12px; padding: 0 15px; cursor: pointer; transition: 0.2s;">ğŸ“·</button>
            </div>
            <div id="own-wallets-list" style="display: none; background: var(--bg); border: 1px solid var(--border); border-radius: 12px; margin-top: 5px; max-height: 150px; overflow-y: auto; padding: 5px;"></div><button onclick="toggleOwnWallets()" style="background: none; border: none; color: var(--primary); font-size: 11px; cursor: pointer; margin-top: 5px; padding: 0 5px;">+ Kirim ke akun saya sendiri</button>
            <br>

            <div id="scanner-container" style="display:none; position: relative; margin-bottom: 20px; border-radius: 16px; overflow: hidden; background: #000; border: 1px solid var(--primary);">
                <video id="video" style="width: 100%; display: block;"></video>
                <canvas id="canvas" hidden></canvas>
                <div style="position: absolute; top: 10px; right: 10px;">
                    <button onclick="stopScan()" style="background: rgba(239,68,68,0.9); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-weight: bold;">âœ•</button>
                </div>
                <div style="position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); color: white; font-size: 11px; background: rgba(0,0,0,0.6); padding: 4px 12px; border-radius: 20px;">Arahkan ke QR Code</div>
            </div>

            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 8px; padding: 0 5px;">
                <span class="text-muted">Jumlah Kirim</span>
                <span style="color: var(--primary); font-weight: 500;">Tersedia: <span id="send-display-balance">0.0000</span> ONE</span>
            </div>

            <div style="position: relative; margin-bottom: 15px;">
                <input type="number" id="send-amount" placeholder="0.00" style="margin-bottom: 0; font-size: 18px; font-weight: 600;">
                <button onclick="setMaxAmount()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: var(--primary); border: none; color: white; border-radius: 8px; cursor: pointer; font-size: 11px; padding: 6px 10px; font-weight: 700;">MAX</button>
            </div>

            <div style="padding: 15px; background: #0f172a; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 10px;">
                    <span class="text-muted">Estimasi Biaya:</span>
                    <span style="color: var(--success); font-weight: 600;"><span id="display-gas-fee">0.000021</span> ONE</span>
                </div>
                
                <details style="font-size: 13px;">
                    <summary style="color: var(--primary); cursor:pointer; font-weight: 500;">Pengaturan Gas Cerdas</summary>
                    <div class="gas-presets">
                        <button class="gas-btn active" onclick="setGasPreset(1, this)">Lambat</button>
                        <button class="gas-btn" onclick="setGasPreset(5, this)">Normal</button>
                        <button class="gas-btn" onclick="setGasPreset(10, this)">Cepat</button>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <div style="flex: 1;">
                            <label class="text-muted" style="font-size: 11px; margin-bottom: 5px; display: block;">Gas Price</label>
                            <input type="number" id="send-gasPrice" value="1" style="padding: 8px; margin-bottom: 0;">
                        </div>
                        <div style="flex: 1;">
                            <label class="text-muted" style="font-size: 11px; margin-bottom: 5px; display: block;">Gas Limit</label>
                            <input type="number" id="send-gasLimit" value="21000" style="padding: 8px; margin-bottom: 0;">
                        </div>
                    </div>
                </details>
            </div>

            <div style="margin-top: auto; display: flex; gap: 12px;">
                <button class="btn btn-outline" style="flex:1" onclick="showDashboard()">Batal</button>
                <button class="btn" style="flex:2" onclick="sendTransaction()">Kirim Sekarang</button>
            </div>
        </div>
        
        <div id="toast" class="toast"></div>
    </div>

    <div id="modal-rename" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ubah Nama</h3>
                <button class="close-btn" onclick="closeRenameModal()">âœ•</button>
            </div>
            <p class="text-muted" style="margin-bottom: 15px;">Berikan identitas unik untuk dompet ini.</p>
            <input type="text" id="new-account-name" placeholder="Contoh: Dompet Utama" maxlength="20">
            <div class="modal-actions">
                <button class="btn btn-outline" style="flex:1" onclick="closeRenameModal()">Batal</button>
                <button class="btn" style="flex:1" onclick="saveNewName()">Simpan</button>
            </div>
        </div>
    </div>

    <div id="modal-backup" class="modal-overlay" style="display:none;">
    <div class="modal-content backup-card">
        <div class="modal-header">
            <h3>Keamanan Cadangan</h3>
            <button class="close-btn" onclick="closeBackupModal()">&times;</button>
        </div>

        <div id="backup-quest-1">
            <div class="backup-warning">
                <strong>Pertanyaan 1 dari 2</strong>
                <p>Apa yang terjadi jika Anda kehilangan Seed Phrase atau Private Key ini?</p>
            </div>
            <div class="quest-options" style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                <button class="btn btn-outline" onclick="handleQuestBackup(1, false)">A. Meminta bantuan Developer untuk reset akun</button>
                <button class="btn btn-outline" onclick="handleQuestBackup(1, true)">B. Saldo hilang selamanya, tidak bisa dipulihkan</button>
            </div>
        </div>

        <div id="backup-quest-2" style="display: none;">
            <div class="backup-warning" style="background: rgba(255, 166, 0, 0.1); color: #ffa600; border-color: #ffa600;">
                <strong>Pertanyaan 2 dari 2</strong>
                <p>Bolehkah Anda memberikan Seed Phrase kepada Admin atau CS yang mengaku ingin membantu?</p>
            </div>
            <div class="quest-options" style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                <button class="btn btn-outline" onclick="handleQuestBackup(2, true)">A. TIDAK BOLEH! Siapapun yang meminta adalah penipu</button>
                <button class="btn btn-outline" onclick="handleQuestBackup(2, false)">B. Boleh, asal mereka memang petugas resmi</button>
            </div>
        </div>

        <div id="backup-main-data" style="display: none;">
            <div class="backup-warning" style="background: rgba(16, 185, 129, 0.1); color: #10b981; border-color: #10b981;">
                <strong>âœ… Verifikasi Berhasil</strong>
                <p>Simpan data di bawah ini di tempat yang aman dan offline.</p>
            </div>

            <div class="backup-section">
                <label>Seed Phrase (12 Kata)</label>
                <div class="key-box">
                    <p id="backup-phrase"></p>
                    <button onclick="copyToClipboard('backup-phrase')">Salin</button>
                </div>
            </div>

            <div class="backup-section">
                <label>Private Key (Hex)</label>
                <div class="key-box">
                    <p id="backup-priv" class="priv-text"></p>
                    <button onclick="copyToClipboard('backup-priv')">Salin</button>
                </div>
            </div>
            <button class="btn" style="width:100%; margin-top:10px" onclick="closeBackupModal()">Saya Sudah Simpan</button>
        </div>
    </div>
</div>

    <div id="modal-tx-detail" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width: 340px;">
        <div class="modal-header">
            <h3>Detail Transaksi</h3>
            <button class="close-btn" onclick="closeModal('modal-tx-detail')">&times;</button>
        </div>
        <div id="tx-detail-content" style="padding: 15px 0; font-size: 13px;">
            </div>
        <button class="btn" onclick="closeModal('modal-tx-detail')" style="width: 100%;">Tutup</button>
    </div>
</div>

<div id="modal-approve" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width: 360px;">
        <div class="modal-header">
            <h3 id="approve-title">Persetujuan</h3>
        </div>
        <div id="approve-content" style="padding: 15px 0; font-size: 14px; color: var(--text-muted);">
            </div>
        <div class="modal-actions" style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-outline" onclick="handleReject()" style="flex: 1; background: #334155;">Tolak</button>
            <button class="btn" onclick="handleApprove()" style="flex: 1; background: var(--success);">Setujui</button>
        </div>
    </div>
</div>

    <script src="bip39.js"></script> 
    <script src="wallet.js"></script>
    <script src="connector.js"></script>
</body>
</html>
